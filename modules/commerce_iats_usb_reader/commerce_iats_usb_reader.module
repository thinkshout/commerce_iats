<?php

/**
 * @file
 * Adds support for an encrypted USB card reader to Commerce iATS.
 */

define('COMMERCE_IATS_CARD_READER_DELIMITER', '|@|');

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Removes amount field from customer code payment method.
 */
function commerce_iats_usb_reader_form_commerce_payment_order_transaction_add_form_alter(&$form, &$form_state, $form_id) {
  if (isset($form_state['payment_method']) && ($form_state['payment_method']['method_id'] == 'iats_credit_card_customer_code')) {
    $form['payment_terminal']['amount']['#access'] = FALSE;
    $form['payment_terminal']['currency_code']['#access'] = FALSE;
  }
}

/**
 * Implements hook_commerce_payment_method_info().
 */
function commerce_iats_usb_reader_commerce_payment_method_info() {
  $payment_methods = array();

  // Add an admin-only payment method to process a credit card and create a
  // customer code without using Card on File.
  $payment_methods['iats_credit_card_customer_code_process'] = array(
    'base' => 'commerce_iats_usb_reader_credit_card_customer_code_process',
    'title' => t('iATS Payments: Admin process credit card and create customer code'),
    'short_title' => t('iATS Admin process credit card and create customer code'),
    'display_title' => t('Admin process credit card and create customer code'),
    'description' => t('Integrates the iATS CustomerLink webservice for the creation of credit card customer codes.'),
    'file' => 'includes/commerce_iats_usb_reader.credit_card_customer_code_process.inc',
    'checkout' => 0,
  );

  return $payment_methods;
}

/**
 * Implements hook_commerce_payment_method_info_alter().
 *
 * Overrides payment methods for use with Card on File.
 */
function commerce_iats_usb_reader_commerce_payment_method_info_alter(&$payment_methods) {
  // Update credit card payment method.
  $payment_methods['iats_credit_card']['base'] = 'commerce_iats_usb_reader_credit_card';
  $payment_methods['iats_credit_card']['file'] = 'modules/commerce_iats_usb_reader/includes/commerce_iats_usb_reader.credit_card.inc';

  // Update credit card customer code creation payment method.
  $payment_methods['iats_credit_card_customer_code']['base'] = 'commerce_iats_usb_reader_credit_card_customer_code';
  $payment_methods['iats_credit_card_customer_code']['file'] = 'modules/commerce_iats_usb_reader/includes/commerce_iats_usb_reader.credit_card_customer_code.inc';
}

/**
 * Returns an array of USB card reader types.
 *
 * @return array
 *   Array of USB card reader IDs mapped to names.
 */
function commerce_iats_usb_reader_types() {
  $types = array(
    '00' => 'IDTech SecureMag USB swiper',
    '02' => 'MagTek Dynamag USB swiper',
  );

  return $types;
}

/**
 * Parses a card type from the obfuscated card number contained in
 * an encrypted string.
 *
 * @param string $encrypted_string
 *   The encrypted string from a USB card reader.
 * @param array $valid_types
 *   An array of valid credit card types.
 *
 * @return Mixed
 *   The credit card type as a string or boolean FALSE.
 */
function commerce_iats_usb_reader_parse_card_type_from_encrypted_string($encrypted_string, $valid_types)
{
  module_load_include('inc', 'commerce_payment', 'includes/commerce_payment.credit_card');

  $matches = NULL;

  // Match pattern:
  // ;4222********2220=
  preg_match("/;\d{4}\*+\d{4}\=/", $encrypted_string, $matches);

  if (empty($matches))
  {
    // Match pattern:
    // ;4222222222222220=
    preg_match("/;\d{16}\=/", $encrypted_string, $matches);
  }

  $card_number = substr(substr($matches[0], 1), 0, -1);

  return commerce_payment_validate_credit_card_type($card_number, $valid_types);
}
